#!/bin/sh
#initramfs init script.
#The root detection is from http://www.thewireframecommunity.com/node/7

echo "EdenLinux initramfs..."

TMP_MOUNT="/mnt/root"

#Mount things needed by this script
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t tmpfs dev /dev
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts


#Create device nodes
#mknod /dev/null c 1 3
#mknod /dev/tty c 5 0
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

#Function for parsing command line options with "=" in them
# get_opt("init=/sbin/init") will return "/sbin/init"
get_opt() {
	echo "$@" | cut -d "=" -f 2
}

#Drop the user into the initramfs busybox shell
rescue_shell()
{
	echo "Something went wrong. Dropping you to a shell."
	busybox --install -s
	exec /bin/sh
}

#Defaults
init="/sbin/init"
root="/dev/hda1"

#Process command line options
for i in $(cat /proc/cmdline); do
	case $i in
		root\=*)
			root=$(get_opt $i)
			;;
		init\=*)
			init=$(get_opt $i)
			;;
	esac
done

if [ $root = "/dev/null" ] ; then
	echo "Detecting CD device"
	# Detecting the live CD is pretty complicated,
	# but is a very logical process
	
	# Search for cdrom devices and add them to CDROM_LIST
	
	CDROM_LIST=""
	
	# Search in proc tree for ide cdrom devices
	# There used to be a section for devfs, but this was
	# edited for udev. Actually we should probably not
	# use /proc anymore, but use sysfs instead...
	# Perhaps in the future;)
	
	# Check for ide channels.
	
	for ide_channel in /proc/ide/ide[0-9]
	do
		
		# If there are no ide channels found, then skip this
		
		if [ ! -d "$ide_channel" ]; then
			break
		fi
		
		# Try each ide device to see if we can find the cd-rom drive
		
		for ide_device in hda hdb hdc hdd hde hdf hdg hdh hdi hdj hdk hdl hdm hdn
		do
			device_media_file="$ide_channel/$ide_device/media"
			if [ -e "$device_media_file" ]; then
				grep -i "cdrom" $device_media_file > /dev/null 2>&1
				if [ $? -eq 0 ]; then
					CDROM_LIST="$CDROM_LIST /dev/$ide_device"
				fi
			fi
		done
	done
	
	# Check for scsi cds
	
	for scsi_cdrom in /dev/scd[0-99]
	do
		if [ -e "$scsi_cdrom" ]; then
			CDROM_LIST="$CDROM_LIST $scsi_cdrom"
		fi
	done
	
	# Check for scsi cds
	
	for scsi_cdrom in /dev/sr[0-99]
	do
		if [ -e "$scsi_cdrom" ]; then
			CDROM_LIST="$CDROM_LIST $scsi_cdrom"
		fi
	done
	
	# Now we try to find the EdenLinux boot CD
	
	root=""
	
	for cdrom_device in $CDROM_LIST
	do
		echo "Looking for EdenLinux liveCD in: ${cdrom_device}"
		mount -n -t iso9660 ${cdrom_device} $TMP_MOUNT
		media_found=$?
		
		media_edenlinux=1
		
		if [ $media_found -eq 0 ]; then
			echo -n "media found"
			if [ -e "$TMP_MOUNT/etc/EdenLive" ]; then
				media_edenlinux=0
			fi
			umount -n $cdrom_device > /dev/null 2>&1
		fi
		
		if [ $media_edenlinux -eq 0 ]; then
			echo ", EdenLinux boot CD found. Ready!"
			root="$cdrom_device"
		else
			rescue_shell
		fi
	done
fi

#Mount the root device
mount $root $TMP_MOUNT

#Check if $init exists and is executable
if [[ -x "$TMP_MOUNT/$init" ]] ; then
	#Unmount all other mounts so that the ram used by
	#the initramfs can be cleared after switch_root
	umount /sys /proc
	
	#Switch to the new root and execute init
	if ! exec switch_root "$TMP_MOUNT" "$init"; then
		mount -t proc proc /proc
		rescue_shell
	fi
else
	echo "Init not found on root filesystem in: $root"
	rescue_shell
fi

rescue_shell




